// Logging utility function.
function trace(arg) {
  var now = (window.performance.now() / 1000).toFixed(3);
  console.log(now + ': ', arg);
}

function uuid() {
  function ko() {
    return Math.floor(Math.random() * 0x10000).toString(16);
  }

  return ko() + ko() + '-' + ko() + '-' + ko() + '-' + ko();
}

function _str(obj) {
  return JSON.stringify(obj);
}

function pageIsVisible() {
  var hidden, visibilityChange;
  if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
    hidden = "hidden";
    visibilityChange = "visibilitychange";
  } else if (typeof document.msHidden !== "undefined") {
    hidden = "msHidden";
    visibilityChange = "msvisibilitychange";
  } else if (typeof document.webkitHidden !== "undefined") {
    hidden = "webkitHidden";
    visibilityChange = "webkitvisibilitychange";
  }

  return !document[hidden];
}

function pageOnVisibilityChange() {
  var visibilityChange;
  if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support
    visibilityChange = "visibilitychange";
  } else if (typeof document.msHidden !== "undefined") {
    visibilityChange = "msvisibilitychange";
  } else if (typeof document.webkitHidden !== "undefined") {
    visibilityChange = "webkitvisibilitychange";
  }

  return visibilityChange;
}

var Middleware = function() {};

Middleware.prototype.use = function(func) {
  this.go = (function(_go, _this) {
    return function(next) {
      return _go.call(_this, func.bind(_this, next.bind(_this)));
    };
  })(this.go, this);
}

Middleware.prototype.go = function(next) {
  return next();
};

module.exports = {
  trace: trace,
  uuid: uuid,
  _str: _str,
  pageIsVisible: pageIsVisible,
  pageOnVisibilityChange: pageOnVisibilityChange,
  Middleware: Middleware,
}
